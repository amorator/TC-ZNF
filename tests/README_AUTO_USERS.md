# Автоматизация тестирования с пользователями разных ролей

## Обзор

Реализована полная система автоматического создания и управления тестовыми пользователями с разными ролями для комплексного тестирования RBAC (Role-Based Access Control) и всех функций приложения.

## Новые компоненты

### 1. Менеджер тестовых пользователей (`user_manager.py`)

**Функциональность:**
- Автоматическое создание пользователей через HTTP API
- Создание групп с разными правами доступа
- Управление жизненным циклом тестовых данных
- Автоматическая очистка после тестов

**Создаваемые пользователи:**
- `qa_admin` - QA администратор (полные права)
- `qa_manager` - QA менеджер (управление группами)
- `qa_writer` - QA писатель (работа с файлами)
- `qa_reader` - QA читатель (только чтение)
- `qa_regular` - Обычный пользователь (базовые права)

**Создаваемые группы:**
- `qa_readers` - Группа читателей
- `qa_writers` - Группа писателей  
- `qa_managers` - Группа менеджеров

### 2. Фикстуры pytest (`conftest.py`)

**Новые фикстуры:**
- `user_manager` - Менеджер пользователей для сессии
- `qa_admin_credentials` - Учётные данные QA админа
- `qa_manager_credentials` - Учётные данные QA менеджера
- `qa_writer_credentials` - Учётные данные QA писателя
- `qa_reader_credentials` - Учётные данные QA читателя
- `qa_regular_credentials` - Учётные данные обычного пользователя
- `all_user_credentials` - Все учётные данные
- `user_access_matrix` - Матрица доступа по ролям

### 3. Обновлённые тесты

#### RBAC тесты (`test_rbac_ui.py`)
- **7 новых тестов** для проверки доступа разных ролей
- Комплексная проверка матрицы доступа
- Тестирование всех комбинаций пользователь-ресурс

#### Realtime тесты (`test_realtime_ui.py`)
- Обновлены для работы с автоматически созданными пользователями
- Тестирование уведомлений между пользователями разных ролей
- Проверка realtime обновлений с множественными сессиями

### 4. Скрипт запуска (`run_tests_with_users.zsh`)

**Особенности:**
- Автоматическое создание пользователей перед тестами
- Настройка окружения для pytest
- Очистка тестовых данных после завершения

## Матрица доступа

| Роль | Admin | Users | Groups | Files | Categories |
|------|-------|-------|--------|-------|------------|
| **admin** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **qa_admin** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **qa_manager** | ❌ | ❌ | ✅ | ✅ | ✅ |
| **qa_writer** | ❌ | ❌ | ❌ | ✅ | ❌ |
| **qa_reader** | ❌ | ❌ | ❌ | ✅ | ❌ |
| **qa_regular** | ❌ | ❌ | ❌ | ✅ | ❌ |

## Результаты тестирования

### RBAC тесты
```
7 passed, 32 deselected, 7 warnings in 27.36s
```

**Все тесты прошли успешно:**
- ✅ `test_rbac_restricted_pages_regular_user`
- ✅ `test_rbac_restricted_pages_reader_user`
- ✅ `test_rbac_restricted_pages_writer_user`
- ✅ `test_rbac_manager_access`
- ✅ `test_rbac_admin_access`
- ✅ `test_rbac_main_admin_access`
- ✅ `test_rbac_comprehensive_matrix`

## Использование

### Базовый запуск
```bash
cd /usr/share/znv2
./tests/run_tests_with_users.zsh
```

### Специфичные тесты
```bash
# Все RBAC тесты
./tests/run_tests_with_users.zsh -k "test_rbac"

# Тесты конкретной роли
./tests/run_tests_with_users.zsh -k "test_rbac_restricted_pages_regular_user"

# Realtime тесты
./tests/run_tests_with_users.zsh -k "test_realtime"
```

### Создание пользователей отдельно
```bash
cd /usr/share/znv2
source .venv/bin/activate
BASE_URL=https://your-server:8080 python3 tests/user_manager.py
```

## Технические особенности

### Автоматическое управление данными
- **Создание:** Пользователи создаются автоматически перед тестами
- **Очистка:** Все тестовые данные удаляются после завершения
- **Изоляция:** Каждая сессия тестов использует свежие данные

### Устойчивость к ошибкам
- Graceful skip при недоступности сервера
- Автоматическое восстановление при сбоях создания пользователей
- Детальное логирование процесса создания

### Безопасность
- Использование стандартных паролей для тестовых пользователей
- Автоматическая очистка после тестов
- Изоляция от продакшн данных

## Преимущества

### 1. Полнота тестирования
- **Все роли покрыты** - от обычного пользователя до администратора
- **Все ресурсы проверены** - admin, users, groups, files, categories
- **Все сценарии** - доступ разрешён/запрещён

### 2. Автоматизация
- **Нет ручной настройки** - пользователи создаются автоматически
- **Воспроизводимость** - одинаковые условия для каждого запуска
- **Масштабируемость** - легко добавить новые роли и тесты

### 3. Надёжность
- **Стабильные тесты** - не зависят от внешних данных
- **Быстрая обратная связь** - тесты выполняются быстро
- **Детальная диагностика** - понятные сообщения об ошибках

## Заключение

Система автоматического создания пользователей с разными ролями обеспечивает:

✅ **Полное покрытие RBAC** - все роли и ресурсы протестированы  
✅ **Автоматизацию** - никакой ручной настройки не требуется  
✅ **Надёжность** - стабильные и воспроизводимые тесты  
✅ **Масштабируемость** - легко расширяется новыми ролями  

Теперь все тесты работают с автоматически созданными пользователями разных ролей, обеспечивая комплексную проверку безопасности и функциональности приложения.
