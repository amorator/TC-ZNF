## ZNF — Заявки/Наряды/Файлы

Полноценное веб‑приложение на Flask для управления файлами, категориями/подкатегориями, пользователями и регистраторами с поддержкой загрузки/импорта, конвертации, аудита действий, сокетов и настраиваемого логирования.

### Возможности

- Файлы: загрузка (одно- и двухфазная), запись из браузера, конвертация, перемещение, заметки, просмотр и скачивание
- Категории/подкатегории: CRUD, защита системной категории `registrators`, динамическая подгрузка
- Регистраторы: CRUD, выдача прав, импорт по прокси с защитами
- Права и роли: постраничные разрешения, админ видит все категории/подкатегории
- Аудит действий пользователей (логин, CRUD, операции с файлами и пр.)
- Настраиваемое логирование и ротация логов
- Реал‑тайм обновления через Socket.IO

---

### Быстрый старт (Dev)

1. Установите зависимости системы (пример для Arch/Ubuntu):

```bash
sudo pacman -S python python-pip ffmpeg # Arch
# или
sudo apt-get install -y python3 python3-pip ffmpeg # Ubuntu/Debian
```

2. Создайте виртуальное окружение и установите Python‑зависимости:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install flask flask-login flask-socketio gevent gevent-websocket bs4
```

3. Настройте `config.ini` (см. раздел Конфигурация). Минимум должны быть заданы блоки `db`, `files`, `socketio` при необходимости.

4. Запустите приложение в dev‑режиме:

```bash
python server.py
```

5. Откройте в браузере:

```
http://localhost:5000/
```

Для продакшена рекомендуется gunicorn + gevent worker.

---

### Запуск (Prod, пример)

```bash
source .venv/bin/activate
export ZNF_CONFIG=/usr/share/znf/config.ini
gunicorn -w 1 -k gevent --bind 0.0.0.0:5000 server:app
```

Socket.IO поддерживается через gevent. Для нескольких воркеров используйте общий message queue (Redis) и настройте `socketio.message_queue` в `config.ini`.

---

### Конфигурация

Приложение читает `config.ini` из рабочей директории. Путь можно переопределить переменными окружения `ZNV2_CONFIG` или `LOG_CONFIG`.

Ключевые секции:

- `[db]`: параметры подключения и префиксы таблиц
- `[files]`: `root` — путь к корню файлов; `max_size_mb` — лимит размера загрузок
- `[socketio]`: `message_queue` — URL очереди сообщений для мульти‑воркеров
- `[logging]`: уровни, форматы и ротация логов (см. ниже)

Пример блока логирования в `config.ini`:

```ini
[logging]
file_level = INFO
console_level = INFO
actions_level = INFO
access_level = INFO
max_bytes = 10485760
backup_count = 5
date_format = %Y-%m-%d %H:%M:%S
console_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
file_format = %(asctime)s [%(levelname)s] %(name)s:%(lineno)d: %(message)s
actions_format = %(asctime)s [%(levelname)s] %(message)s
access_format = %(asctime)s %(message)s
```

---

### Логи

Логи пишутся в директорию `logs/` рядом с исходниками:

- `app.log` — общие логи приложения
- `error.log` — ошибки уровня ERROR и выше
- `access.log` — HTTP‑доступ (по усмотрению middleware)
- `actions.log` — аудит действий пользователей

Ротация логов — `RotatingFileHandler` с настраиваемыми `max_bytes` и `backup_count`.

Аудит доступен через функцию `log_action(action, user, details, ip, success)` и расставлен по ключевым операциям (логин/логаут, upload/edit/delete/move/refresh/note, CRUD категорий/подкатегорий, запись/импорт).

---

### Безопасность

Прокси `/proxy/<url>` используется исключительно кодом импорта с регистратора и защищён:

- проверка Referer (`/files/`)
- обязательный заголовок `X-Registrator-Import: 1`
- проверка User‑Agent
- rate‑limit по IP (1 запрос/сек)
- валидация формата URL (`!` как разделитель)
- фильтрация подозрительных шаблонов (`..`, `admin`, `config`, `etc`, `proc`)

Security‑логи краткие, без утечек чувствительных данных (не логируются полный referer/UA/URL‑контент и списки ключей директорий).

Права и доступ к дереву директорий формируются в `services/permissions.py`. Администратор видит все категории и подкатегории. Для остальных действует фильтрация по группе.

---

### Файлы и загрузки

- Обычная загрузка: эндпоинт `/files/add/<did>/<sdid>` (AJAX или форма)
- Двухфазная: `/files/add/init/<did>/<sdid>` -> `/files/upload/<did>/<sdid>/<id>`
- Отмена загрузки: клиент отслеживает загруженные `id` и выполняет очистку через `/files/delete/<did>/<sdid>/<id>`; на сервере запросы помечаются заголовком `X-Upload-Cleanup: 1` для аудита.
- Конвертация выполняется асинхронно (MediaService + ffmpeg/ffprobe).
- Перемещение между подкатегориями поддерживает как id‑поля, так и легаси по именам.

Подкатегории с одинаковым `folder_name`, как у родителя, обрабатываются специальным ключом `__dup_<id>` на сервере и нормализуются на клиенте.

---

### Регистраторы

- CRUD регистраторов, права доступа и статистика
- Импорт работает через `/proxy` с защитами (см. Безопасность)
- UI кэширует список регистраторов, контекстное меню доступно «по всей странице» для активного элемента

---

### UI/Frontend

Основные скрипты:

- `static/js/files.js` — управление файлами, загрузки, прогресс, модалки
- `static/js/registrators.js` — регистраторы, контекстное меню, модалки
- `static/js/categories.js`, `static/js/users.js`, `static/js/groups.js` — админские страницы

В шаблоне `templates/files.j2.html` данные директорий экспортируются в `window.dirsData` и атрибуты `data-*` для корректной работы модалок перемещения.

---

### Тестирование и отладка

- Проверьте доступность страниц: `/files`, `/registrators`, `/categories`
- Убедитесь, что логи создаются в `logs/` и не содержат лишней отладочной информации
- Для Socket.IO в мульти‑воркере — настройте общий `message_queue`

---

### Частые проблемы

- `ffprobe` не найден: установите `ffmpeg`
- Ошибки записи в файловую систему: проверьте права пользователя процесса на `files.root`
- Логи не создаются: убедитесь в наличии прав на каталог `logs/`
- JSON‑ответ вместо HTML (или наоборот): проверьте заголовок `X-Requested-With: XMLHttpRequest` на клиента

---

### Структура проекта (основное)

- `server.py` — создание приложения, Socket.IO, прокси, обработчики ошибок
- `modules/logging.py` — централизованное конфигурируемое логирование и аудит
- `services/permissions.py` — выдача дерева директорий с учётом прав
- `routes/*` — Flask‑роуты (`files.py`, `categories.py`, `registrators.py`, ...)
- `templates/*` — Jinja2‑шаблоны
- `static/js/*` — фронтенд‑логика
- `logs/*` — логи приложения

---
