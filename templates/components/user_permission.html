{# Hidden field to submit legacy permission string; UI uses only checkboxes #}
{% set perm_input_id = perm_input_id or 'perm-string' %}
<input type="hidden" name="permission" id="{{ perm_input_id }}" />

<div class="popup__form-control form-control">
    {% set perm_box_id = (perm_input_id ~ '-box') %}
    <span class="form-control__label">Разрешения</span>
    <div id="{{ perm_box_id }}" class="permissions-grid">
        <div class="permissions-group" data-page="1">
            <div class="permissions-group__title">Заявки</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p1[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="e" name="perms_p1[]"
                    value="e"><span class="form-check-label"> Утверждение</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="f" name="perms_p1[]"
                    value="f"><span class="form-check-label"> Разрешение</span></label>
        </div>
        <div class="permissions-group" data-page="4">
            <div class="permissions-group__title">Пользователи</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p4[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="b" name="perms_p4[]"
                    value="b"><span class="form-check-label"> Управление</span></label>
        </div>
        <div class="permissions-group" data-page="3">
            <div class="permissions-group__title">Файлы</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p3[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="b" name="perms_p3[]"
                    value="b"><span class="form-check-label"> Загрузка/Запись</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="c" name="perms_p3[]"
                    value="c"><span class="form-check-label"> Изменение</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="d" name="perms_p3[]"
                    value="d"><span class="form-check-label"> Удаление</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="f" name="perms_p3[]"
                    value="f"><span class="form-check-label"> Отображать все записи</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="l" name="perms_p3[]"
                    value="l"><span class="form-check-label"> Просмотревшие</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="m" name="perms_p3[]"
                    value="m"><span class="form-check-label"> Отмечать просмотр</span></label>
        </div>
        <div class="permissions-group" data-page="5">
            <div class="permissions-group__title">Группы</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p5[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="b" name="perms_p5[]"
                    value="b"><span class="form-check-label"> Управление</span></label>
        </div>
        <div class="permissions-group" data-page="2">
            <div class="permissions-group__title">Наряды</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p2[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
        </div>
        <div class="permissions-group" data-page="6">
            <div class="permissions-group__title">Администрирование</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p6[]"
                    value="a"><span class="form-check-label"> Просмотр</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="b" name="perms_p6[]"
                    value="b"><span class="form-check-label"> Действия</span></label>
        </div>
        <div class="permissions-group" data-page="7">
            <div class="permissions-group__title">Категории</div>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="a" name="perms_p7[]"
                    value="a"><span class="form-check-label"> Просмотр категорий</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="b" name="perms_p7[]"
                    value="b"><span class="form-check-label"> Управление категориями</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="c" name="perms_p7[]"
                    value="c"><span class="form-check-label"> Просмотр подкатегорий</span></label>
            <label class="form-check"><input class="form-check-input" type="checkbox" data-letter="d" name="perms_p7[]"
                    value="d"><span class="form-check-label"> Управление подкатегориями</span></label>
        </div>
        <div class="permissions-group permissions-group--admin" data-page="admin">
            <div class="permissions-group__title">Администратор</div>
            <label class="form-check"><input class="form-check-input" type="checkbox"
                    id="{{ perm_input_id }}-admin-full-toggle" data-admin-toggle="1"><span class="form-check-label">
                    Полный доступ</span></label>
        </div>
    </div>
    <small class="form-text text-muted">Отметьте нужные права для каждой страницы.</small>
</div>

<script>
    // Minimal, local to this partial. Avoid globals by scoping to container.
    (function () {
        var input = document.getElementById('{{ perm_input_id }}');
        var box = document.getElementById('{{ perm_box_id }}');
        if (!input || !box) return;

        // Guard flags to prevent recursive updates breaking the UI
        var internalUpdate = false;

        function buildLegacyFromBoxes() {
            // Pages 1..7 -> collect checked letters
            var pages = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [] };
            var groups = box.querySelectorAll('.permissions-group');
            groups.forEach(function (group) {
                var page = parseInt(group.getAttribute('data-page'), 10);
                var letters = [];
                group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                    if (cb.checked) letters.push(cb.getAttribute('data-letter'));
                });
                // sort for stable output
                letters.sort();
                pages[page] = letters;
            });
            // Join into CSV per page, ensure we output 7 pages
            var arr = [];
            for (var i = 1; i <= 7; i++) {
                arr.push(pages[i].join(''));
            }
            input.value = arr.join(',');
        }

        function applyBoxesFromLegacy() {
            // Expect format: 7 comma-separated strings (can be fewer — pad)
            var raw = (input.value || '').trim();
            var parts = raw.split(',');
            // Some legacy strings may include extra segments or use 'z' for full admin.
            // Normalize to 7 parts; keep extras for admin check only
            while (parts.length < 7) parts.push('');
            var groups = box.querySelectorAll('.permissions-group:not([data-page="admin"])');
            groups.forEach(function (group) {
                var page = parseInt(group.getAttribute('data-page'), 10);
                var letters = (parts[page - 1] || '').split('');
                var set = {};
                letters.forEach(function (ch) { set[ch] = true; });
                group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                    var ch = cb.getAttribute('data-letter');
                    cb.checked = !!set[ch];
                });
                enforceViewDependency(group);
            });
            // If any segment contains 'z', enable Admin full toggle and lock others
            if (!internalUpdate) {
                try {
                    var hasZ = parts.some(function (seg) { return (seg || '').indexOf('z') !== -1; });
                    var isFull7 = (raw === 'aef,a,abcdflm,ab,ab,ab,abcd');
                    if (hasZ || isFull7) {
                        setAdminFull(true);
                    }
                } catch (_) { }
            }
        }

        function enforceViewDependency(group) {
            try {
                // Do not auto-lock Files group (data-page="3") view checkbox
                if (group && group.getAttribute('data-page') === '3') return;
                var viewCb = group.querySelector('input[type="checkbox"][data-letter="a"]');
                if (!viewCb) return;
                var anyOther = false;
                group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                    var ch = cb.getAttribute('data-letter');
                    if (ch && ch !== 'a' && cb.checked) { anyOther = true; }
                });
                if (anyOther) {
                    viewCb.checked = true;
                    viewCb.disabled = true;
                } else {
                    viewCb.disabled = false;
                }
            } catch (_) { }
        }

        function setAdminFull(on) {
            var adminToggle = document.getElementById('{{ perm_input_id }}-admin-full-toggle');
            internalUpdate = true;
            if (adminToggle) {
                adminToggle.checked = !!on;
            }
            var groups = box.querySelectorAll('.permissions-group');
            // When admin is ON: set full access and disable all others
            if (on) {
                // full access string (7 pages):
                // p1(Requests): aef; p2(Orders): a; p3(Files): abcdflm; p4(Users): ab; p5(Groups): ab; p6(Admin): ab; p7(Categories): abcd
                input.value = 'aef,a,abcdflm,ab,ab,ab,abcd';
                // Reflect checkboxes
                applyBoxesFromLegacy();
                try {
                    if (adminToggle) {
                        adminToggle.focus();
                        if (typeof adminToggle.scrollIntoView === 'function') {
                            adminToggle.scrollIntoView({ block: 'nearest' });
                        }
                    }
                } catch (_) { }
            }
            internalUpdate = false;
            // Do not globally disable other groups; per-page enforcement happens elsewhere
            if (!on) {
                // Ensure legacy string reflects current boxes when admin is turned off
                buildLegacyFromBoxes();
            }
        }

        // Wire events
        box.addEventListener('change', function (e) {
            if (internalUpdate) return;
            if (e.target && e.target.matches('input[type="checkbox"][data-letter]')) {
                buildLegacyFromBoxes();
                // If user manually changes any box, turn off admin full toggle
                setAdminFull(false);
                // Enforce that selecting any non-view permission checks and locks view
                try {
                    var group = e.target.closest('.permissions-group');
                    if (group && group.getAttribute('data-page') !== 'admin') {
                        enforceViewDependency(group);
                    }
                } catch (_) { }
            }
        });
        var adminToggle = document.getElementById('{{ perm_input_id }}-admin-full-toggle');
        if (adminToggle) {
            adminToggle.addEventListener('change', function () {
                setAdminFull(adminToggle.checked);
            });
        }
        // Re-apply when hidden input value changes programmatically
        ['change', 'input'].forEach(function (evt) {
            input.addEventListener(evt, function () {
                if (internalUpdate) return;
                applyBoxesFromLegacy();
            });
        });

        // Expose a refresh hook for external callers (by id and generic)
        window['refreshPermUI_{{ perm_input_id }}'] = function () {
            var raw = (input.value || '').trim();
            applyBoxesFromLegacy();
            try {
                var parts = raw.split(',');
                while (parts.length < 7) parts.push('');
                var hasZ = parts.some(function (seg) { return (seg || '').indexOf('z') !== -1; });
                var isFull = (raw === 'aef,a,abcdflm,ab,ab,ab,abcd');
                if (hasZ || isFull) setAdminFull(true);
            } catch (_) { }
        };
        if (!window.refreshPermissionUI) {
            window.refreshPermissionUI = function (inputId) {
                try {
                    var hidden = document.getElementById(inputId);
                    if (hidden) {
                        var fn = window['refreshPermUI_' + inputId];
                        if (typeof fn === 'function') fn();
                    }
                } catch (_) { }
            };
        }
        // On first load, reflect input->boxes; if empty, keep unchecked
        applyBoxesFromLegacy();
        // If current legacy string already equals full-admin, enable admin toggle and lock boxes
        if ((input.value || '') === 'aef,a,abcdflm,ab,ab,ab,abcd') {
            setAdminFull(true);
        }
    })();
</script>