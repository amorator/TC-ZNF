{# Hidden field to submit legacy permission string; UI uses only checkboxes #}
{% set perm_input_id = perm_input_id or 'perm-string' %}
<input type="hidden" name="permission" id="{{ perm_input_id }}" />

<div class="popup__form-control form-control">
    {% set perm_box_id = (perm_input_id ~ '-box') %}
    <span class="form-control__label">Разрешения</span>
    <div id="{{ perm_box_id }}" class="permissions-grid">
        <div class="permissions-group" data-page="1">
            <div class="permissions-group__title">Заявки</div>
            <label><input type="checkbox" data-letter="a" name="perms_p1[]" value="a"> Просмотр</label>
            <label><input type="checkbox" data-letter="e" name="perms_p1[]" value="e"> Утверждение</label>
            <label><input type="checkbox" data-letter="f" name="perms_p1[]" value="f"> Разрешение</label>
        </div>
        <div class="permissions-group" data-page="2">
            <div class="permissions-group__title">Наряды</div>
            <label><input type="checkbox" data-letter="a" name="perms_p2[]" value="a"> Просмотр</label>
        </div>
        <div class="permissions-group" data-page="3">
            <div class="permissions-group__title">Файлы</div>
            <label><input type="checkbox" data-letter="a" name="perms_p3[]" value="a"> Просмотр</label>
            <label><input type="checkbox" data-letter="b" name="perms_p3[]" value="b"> Загрузка/Запись</label>
            <label><input type="checkbox" data-letter="c" name="perms_p3[]" value="c"> Изменение</label>
            <label><input type="checkbox" data-letter="d" name="perms_p3[]" value="d"> Удаление</label>
            <label><input type="checkbox" data-letter="f" name="perms_p3[]" value="f"> Отображать все записи</label>
            <label><input type="checkbox" data-letter="l" name="perms_p3[]" value="l"> Просмотревшие</label>
            <label><input type="checkbox" data-letter="m" name="perms_p3[]" value="m"> Отмечать просмотр</label>
        </div>
        <div class="permissions-group" data-page="4">
            <div class="permissions-group__title">Пользователи</div>
            <label><input type="checkbox" data-letter="a" name="perms_p4[]" value="a"> Просмотр</label>
            <label><input type="checkbox" data-letter="b" name="perms_p4[]" value="b"> Управление</label>
        </div>
        <div class="permissions-group permissions-group--admin" data-page="admin">
            <div class="permissions-group__title">Администратор</div>
            <label><input type="checkbox" id="{{ perm_input_id }}-admin-full-toggle" data-admin-toggle="1"> Полный
                доступ</label>
        </div>
    </div>
    <small class="form-text text-muted">Отметьте нужные права для каждой страницы.</small>
</div>

<script>
    // Minimal, local to this partial. Avoid globals by scoping to container.
    (function () {
        var input = document.getElementById('{{ perm_input_id }}');
        var box = document.getElementById('{{ perm_box_id }}');
        if (!input || !box) return;

        // Guard flags to prevent recursive updates breaking the UI
        var internalUpdate = false;

        function buildLegacyFromBoxes() {
            // Pages 1..4 -> collect checked letters
            var pages = { 1: [], 2: [], 3: [], 4: [] };
            var groups = box.querySelectorAll('.permissions-group');
            groups.forEach(function (group) {
                var page = parseInt(group.getAttribute('data-page'), 10);
                var letters = [];
                group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                    if (cb.checked) letters.push(cb.getAttribute('data-letter'));
                });
                // sort for stable output
                letters.sort();
                pages[page] = letters;
            });
            // Join into CSV per page, ensure we output 4 pages
            var arr = [];
            for (var i = 1; i <= 4; i++) {
                arr.push(pages[i].join(''));
            }
            input.value = arr.join(',');
        }

        function applyBoxesFromLegacy() {
            // Expect format: 4 comma-separated strings (can be fewer — pad)
            var raw = (input.value || '').trim();
            var parts = raw.split(',');
            // Some legacy strings may include extra segments or use 'z' for full admin.
            // Normalize to 4 parts; keep extras for admin check only
            while (parts.length < 4) parts.push('');
            var groups = box.querySelectorAll('.permissions-group:not([data-page="admin"])');
            groups.forEach(function (group) {
                var page = parseInt(group.getAttribute('data-page'), 10);
                var letters = (parts[page - 1] || '').split('');
                var set = {};
                letters.forEach(function (ch) { set[ch] = true; });
                group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                    var ch = cb.getAttribute('data-letter');
                    cb.checked = !!set[ch];
                });
            });
            // If any segment contains 'z', enable Admin full toggle and lock others
            if (!internalUpdate) {
                try {
                    var hasZ = parts.some(function (seg) { return (seg || '').indexOf('z') !== -1; });
                    var isFull = (raw === 'aef,a,abcdflm,ab');
                    if (hasZ || isFull) {
                        setAdminFull(true);
                    }
                } catch (_) { }
            }
        }

        function setAdminFull(on) {
            var adminToggle = document.getElementById('{{ perm_input_id }}-admin-full-toggle');
            internalUpdate = true;
            if (adminToggle) {
                adminToggle.checked = !!on;
            }
            var groups = box.querySelectorAll('.permissions-group');
            // When admin is ON: set full access and disable all others
            if (on) {
                // full access string: p1: aef; p2: a; p3: abcdflm; p4: ab
                input.value = 'aef,a,abcdflm,ab';
                // Reflect checkboxes
                applyBoxesFromLegacy();
                try {
                    if (adminToggle) {
                        adminToggle.focus();
                        if (typeof adminToggle.scrollIntoView === 'function') {
                            adminToggle.scrollIntoView({ block: 'nearest' });
                        }
                    }
                } catch (_) { }
            }
            internalUpdate = false;
            groups.forEach(function (group) {
                if (group.getAttribute('data-page') !== 'admin') {
                    group.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
                        cb.disabled = !!on;
                    });
                }
            });
            if (!on) {
                // Ensure legacy string reflects current boxes when admin is turned off
                buildLegacyFromBoxes();
            }
        }

        // Wire events
        box.addEventListener('change', function (e) {
            if (internalUpdate) return;
            if (e.target && e.target.matches('input[type="checkbox"][data-letter]')) {
                buildLegacyFromBoxes();
                // If user manually changes any box, turn off admin full toggle
                setAdminFull(false);
            }
        });
        var adminToggle = document.getElementById('{{ perm_input_id }}-admin-full-toggle');
        if (adminToggle) {
            adminToggle.addEventListener('change', function () {
                setAdminFull(adminToggle.checked);
            });
        }
        // Re-apply when hidden input value changes programmatically
        ['change', 'input'].forEach(function (evt) {
            input.addEventListener(evt, function () {
                if (internalUpdate) return;
                applyBoxesFromLegacy();
            });
        });

        // Expose a refresh hook for external callers (by id and generic)
        window['refreshPermUI_{{ perm_input_id }}'] = function () {
            var raw = (input.value || '').trim();
            applyBoxesFromLegacy();
            try {
                var parts = raw.split(',');
                while (parts.length < 4) parts.push('');
                var hasZ = parts.some(function (seg) { return (seg || '').indexOf('z') !== -1; });
                var isFull = (raw === 'aef,a,abcdflm,ab');
                if (hasZ || isFull) setAdminFull(true);
            } catch (_) { }
        };
        if (!window.refreshPermissionUI) {
            window.refreshPermissionUI = function (inputId) {
                try {
                    var hidden = document.getElementById(inputId);
                    if (hidden) {
                        var fn = window['refreshPermUI_' + inputId];
                        if (typeof fn === 'function') fn();
                    }
                } catch (_) { }
            };
        }
        // On first load, reflect input->boxes; if empty, keep unchecked
        applyBoxesFromLegacy();
        // If current legacy string already equals full-admin, enable admin toggle and lock boxes
        if ((input.value || '') === 'aef,a,abcdflm,ab') {
            setAdminFull(true);
        }
    })();
</script>