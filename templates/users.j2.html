{% extends 'base.j2.html' %}
{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/search.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/users.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/popup.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/select.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/input.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/checkbox.css') }}"/>
{% endblock %}

{% block main %}

  <section class="users-page container-fluid py-3">
    <table class="users-page__table files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" data-can-manage="{{ 1 if current_user.has('users.manage') else 0 }}" data-server-paging="1">
      <thead class="table__head">
        <tr class="table__head_row">
          <th class="table__head_item">Логин</th>
          <th class="table__head_item">Имя</th>
          <th class="table__head_item">Группа</th>
          <th class="table__head_item">Разрешения</th>
          <th class="table__head_item">Активен</th>
        </tr>
      </thead>
      <tbody class="table__body">
        <tr id="search" class="table__body_actions">
          <td class="table__body_action" colspan="5">
            {% include 'components/searchbar.html' %}
          </td>
        </tr>
        {% if users %}
          {% for user in users %}
            {# Определяем полный доступ с учётом новых прав #}
            {% set is_admin = user.has('admin.any') %}
            
            <tr id="{{ user.id }}" class="table__body_row" data-id="{{ user.id }}" data-enabled="{{ 1 if user.is_enabled() else 0 }}" data-login="{{ user.login }}" data-name="{{ user.name }}" data-gid="{{ user.gid }}" data-groupname="{{ groups[user.gid] }}" data-perm="{{ user.permission_string() }}" data-is-admin="{{ 1 if user.login|lower == 'admin' else 0 }}" data-full-access="{{ 1 if is_admin else 0 }}">
              <td class="table__body_item">
                <span class="users-page__login">{{ user.login }}</span>
                {% if user.login|lower == 'admin' %}
                  <i class="bi bi-shield-fill-check text-danger ms-1" title="Администратор системы"></i>
                {% endif %}
              </td>
              <td class="table__body_item"><span class="users-page__name" title="Клик — скопировать имя">{{ user.name }}</span></td>
              <td class="table__body_item">{{ groups[user.gid] }}</td>
              <td class="table__body_item perms-cell">
                {# If admin rights present, show only Admin line and skip others #}
                {% if is_admin %}
                  <div class="perms-cell__item">
                    <span class="perms-cell__cat">Админ</span>: <span class="perms-cell__rights">полный доступ</span>
                  </div>
                {% else %}
                  {# Use this user's permission labels #}
                  {% set perm_labels = user.permission_labels() %}
                  {# Build ordered unique list of categories first #}
                  {% set cats = namespace(items=[]) %}
                  {% for label in perm_labels %}
                    {% set parts = label.split(':', 1) %}
                    {% set cat = parts[0].strip() %}
                    {% if not cat.lower().startswith('администратор') %}
                      {% if cat and (cat not in cats.items) %}
                        {% set _ = cats.items.append(cat) %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}

                  {# For each category, collect and normalize rights, then render one line #}
                  {% for cat in cats.items %}
                    {% set rights_ns = namespace(list=[]) %}
                    {% for label in perm_labels %}
                      {% set parts = label.split(':', 1) %}
                      {% if parts and parts[0].strip() == cat and parts|length > 1 %}
                        {% set raw = parts[1].strip() %}
                        {% set raw = raw.replace(';', ',') %}
                        {% set raw = raw.replace('Загрузка/Запись', 'Загрузка') %}
                        {% set raw = raw|lower %}
                        {% for item in raw.split(',') %}
                          {% set it = item.strip() %}
                          {% if it and (it not in rights_ns.list) %}
                            {% set _ = rights_ns.list.append(it) %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}

                    {# If there are other rights, hide 'просмотр' #}
                    {% set final_ns = namespace(list=[]) %}
                    {% for r in rights_ns.list %}
                      {% if not (rights_ns.list|length > 1 and r == 'просмотр') %}
                        {% set _ = final_ns.list.append(r) %}
                      {% endif %}
                    {% endfor %}

                    <div class="perms-cell__item">
                      <span class="perms-cell__cat">{{ cat }}</span>: <span class="perms-cell__rights">{{ final_ns.list|join(', ') }}</span>
                    </div>
                  {% endfor %}
                {% endif %}
              </td>
              <td class="table__body_item" data-enabled="{{ 1 if user.is_enabled() else 0 }}">
                <i class="bi {{ 'bi-toggle-on' if user.is_enabled() else 'bi-toggle-off' }}"></i>
              </td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </section>

  <div id="users-pagination" class="files-pagination d-flex justify-content-center py-2"></div>

  <div id="popup-add" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Добавление пользователя</h1>
      <div class="popup__body">
        <form class="popup__form" id="add" name="add" action="{{ url_for('users_add') }}" method="post" onsubmit="return false;">
          <div class="perm-layout">
            <div class="perm-layout__left">
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-login">Логин:</label>
                <input id="add-login" type="text" name="login" class="input form-control__control" placeholder="Введите логин..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-name">Имя:</label>
                <input id="add-name" type="text" name="name" class="input form-control__control" placeholder="Введите имя..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-password">Пароль:</label>
                <input id="add-password" type="password" name="password" class="input form-control__control" placeholder="Введите пароль..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-password2">Подтвердите пароль:</label>
                <input id="add-password2" type="password" name="password2" class="input form-control__control" placeholder="Подтвердите пароль..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-group">Группа:</label>
                <select id="add-group" name="group" class="select form-control__control">
                  {% for g in groups %}
                    <option class="select__option" value="{{ g }}">
                      {{ groups[g] }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="popup__form-control form-control">
                <label class="checkbox" for="add-enabled">Активен:

                  <input id="add-enabled" class="visually-hidden" type="checkbox" name="enabled" checked="checked"/>

                  <span class="checkbox__flag"></span>
                </label>
              </div>
            </div>
            <div class="perm-layout__right">
              {% set perm_input_id = 'perm-string-add' %}
              {% include 'components/user_permission.html' %}
            </div>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-add');">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="validateForm(this);">Добавить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Context menu for users table -->
  <div id="context-menu" class="context-menu d-none">
    <ul class="context-menu__list">
      <li class="context-menu__item" data-action="toggle">Включить</li>
      <li class="context-menu__item" data-action="edit">Изменить</li>
      <li class="context-menu__item" data-action="perm">Изменить разрешения</li>
      <li class="context-menu__item" data-action="reset">Сбросить пароль</li>
      <li class="context-menu__item" data-action="delete">Удалить</li>
      <li class="context-menu__separator"></li>
      <li class="context-menu__item" data-action="add">Добавить</li>
    </ul>
  </div>

  <div id="popup-perm" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Изменение разрешений</h1>
      <div class="popup__body">
        <form class="popup__form" id="perm" name="perm" action="{{ url_for('users_edit', id='0') }}" method="post" onsubmit="return false;">
          {# Скрытые поля, чтобы при сохранении через users_edit не терялись остальные данные #}
          <input type="hidden" name="login" value="" />
          <input type="hidden" name="name" value="" />
          <input type="hidden" name="group" value="" />
          <input type="hidden" name="enabled" value="" />

          <div class="perm-layout">
            <div class="perm-layout__right" style="grid-column: 1 / -1;">
              {% set perm_input_id = 'perm-string-perm' %}
              {% include 'components/user_permission.html' %}
            </div>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" onclick="popupToggle('popup-perm');">Отмена</button>
            <button class="btn btn-primary" type="button" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  

  <div id="popup-edit" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Редактирование пользователя</h1>
      <div class="popup__body">
        <form class="popup__form" id="edit" name="edit" action="{{ url_for('users_edit', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-login">Логин:</label>
            <input id="edit-login" type="text" name="login" class="input form-control__control" placeholder="Введите логин..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-name">Имя:</label>
            <input id="edit-name" type="text" name="name" class="input form-control__control" placeholder="Введите имя..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-group">Группа:</label>
            <select id="edit-group" name="group" class="select form-control__control">
              {% for g in groups %}
                <option class="select__option" value="{{ g }}">
                  {{ groups[g] }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="popup__form-control form-control">
            <label class="checkbox" for="edit-enabled">Активен:

              <input id="edit-enabled" class="visually-hidden checkbox-active" type="checkbox" name="enabled"/>

              <span class="checkbox__flag"></span>
            </label>
          </div>
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" onclick="popupToggle('popup-edit');">Отмена</button>
            <button class="btn btn-primary" type="button" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  

  <div id="popup-reset" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Изменение пароля пользователя</h1>
      <div class="popup__body">
        <p>Установить новый пароль для
          <b>uname</b>
        </p>
        <form class="popup__form" id="reset" name="reset" action="{{ url_for('users_reset', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="reset-password">Новый пароль:</label>
            <input id="reset-password" class="input form-control__control" type="password" name="password" placeholder="Введите пароль..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="reset-password2">Подтвердите пароль:</label>
            <input id="reset-password2" class="input form-control__control" type="password" name="password2" placeholder="Подтвердите пароль..." autocomplete="one-time-code"/>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-reset');">Отмена</button>
            <button class="btn btn-primary" type="button" onclick="validateForm(this);">Изменить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Удалить пользователя</h1>
      <div class="popup__body">
        <p>Вы действительно хотите удалить пользователя
          <b>uname</b>?</p>
        <form class="popup__form" id="delete" name="delete" action="{{ url_for('users_delete', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-delete');">Отмена</button>
            <button type="button" class="btn btn-danger" onclick="validateForm(this);">Удалить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
<script>
  // Pass config values to JavaScript
  window.CONFIG = {
    min_password_length: {{ min_password_length }}
  };
</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/modal-manager.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/context-menu.js') }}" defer="defer"></script>
<script src="{{ url_for('static', filename='js/users.js') }}" defer="defer"></script>
{% endblock %}
