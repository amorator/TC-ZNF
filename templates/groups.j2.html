{% extends 'base.j2.html' %}
{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/search.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/groups.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/popup.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/input.css') }}"/>
{% endblock %}

{% block main %}

  <section class="groups-page container-fluid py-3">
    <table class="groups-page__table files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" data-can-manage="{{ 1 if current_user.has('users.manage') else 0 }}">
      <thead class="table__head">
        <tr class="table__head_row">
          <th class="table__head_item">Название</th>
          <th class="table__head_item">Описание</th>
          <th class="table__head_item">Пользователей</th>
          <th class="table__head_item">Создана</th>
        </tr>
      </thead>
      <tbody class="table__body">
        <tr id="search" class="table__body_actions">
          <td class="table__body_action" colspan="4">
            {% include 'components/searchbar.html' %}
          </td>
        </tr>
        {% if groups %}
          {% for group in groups %}
            <tr id="{{ group.id }}" class="table__body_row" data-id="{{ group.id }}" data-name="{{ group.name }}" data-description="{{ group.description }}" data-is-system="{{ 1 if group.is_system_group(admin_group_name) else 0 }}">
              <td class="table__body_item">
                <span class="groups-page__name">{{ group.name }}</span>
                {% if group.is_system_group(admin_group_name) %}
                  <i class="bi bi-shield-fill-check text-danger ms-1" title="Системная группа"></i>
                {% endif %}
              </td>
              <td class="table__body_item">{{ group.description or '—' }}</td>
              <td class="table__body_item">
                <span class="groups-page__user-count">{{ group.user_count if group.user_count is defined else 0 }}</span>
              </td>
              <td class="table__body_item">{{ group.created_at.strftime('%Y-%m-%d %H:%M') if group.created_at else '—' }}</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </section>

  <div id="popup-add" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Добавление группы</h1>
      <div class="popup__body">
        <form class="popup__form" id="add" name="add" action="{{ url_for('groups_add') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="add-name">Название:</label>
            <input id="add-name" type="text" name="name" class="input form-control__control" placeholder="Введите название группы..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="add-description">Описание:</label>
            <textarea id="add-description" name="description" class="input form-control__control" placeholder="Введите описание группы..." autocomplete="one-time-code"></textarea>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-add');">Отмена</button>
            <button type="button" class="btn btn-primary" onclick="validateForm(this);">Добавить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Context menu for groups table -->
  <div id="context-menu" class="context-menu d-none">
    <ul class="context-menu__list">
      <li class="context-menu__item" data-action="edit">Изменить</li>
      <li class="context-menu__item" data-action="delete">Удалить</li>
      <li class="context-menu__separator"></li>
      <li class="context-menu__item" data-action="add">Добавить</li>
    </ul>
  </div>

  <div id="popup-edit" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Редактирование группы</h1>
      <div class="popup__body">
        <form class="popup__form" id="edit" name="edit" action="{{ url_for('groups_edit', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-name">Название:</label>
            <input id="edit-name" type="text" name="name" class="input form-control__control" placeholder="Введите название группы..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-description">Описание:</label>
            <textarea id="edit-description" name="description" class="input form-control__control" placeholder="Введите описание группы..." autocomplete="one-time-code"></textarea>
          </div>
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" onclick="popupToggle('popup-edit');">Отмена</button>
            <button class="btn btn-primary" type="button" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title mb-4">Удалить группу</h1>
      <div class="popup__body">
        <p>Вы действительно хотите удалить группу <b>gname</b>?</p>
        <form class="popup__form" id="delete" name="delete" action="{{ url_for('groups_delete', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-delete');">Отмена</button>
            <button type="button" class="btn btn-danger" onclick="validateForm(this);">Удалить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
<script type="text/javascript">
  // Pass admin group name to JavaScript
  window.adminGroupName = '{{ admin_group_name }}';
</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/modal-manager.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/context-menu.js') }}" defer="defer"></script>
<script src="{{ url_for('static', filename='js/groups.js') }}" defer="defer"></script>
{% endblock %}

