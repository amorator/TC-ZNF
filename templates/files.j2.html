{% extends 'base.j2.html' %}

{% block css %}
<link rel="stylesheet" href="{{url_for('static',filename='css/components/table.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/components/search.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/files.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/components/select.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/components/popup.css')}}" />
<link rel="stylesheet" href="{{url_for('static',filename='css/components/input.css')}}"/>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/modal-manager.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/context-menu.js') }}" defer="defer"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/files.js') }}" defer="defer"></script>
{% endblock %}

{% block main %}
  <section class="files-page container-fluid py-3">
    <!-- Категории (директории верхнего уровня) -->
    <div class="subbar cat">
      <div class="subbar__group">
        {% if dirs and (dirs | length) > 0 %}
          {% for i in range(dirs | length) %}
            <a class="topbtn {{ 'active' if i == did else '' }}" href="{{ url_for('files', did=i, sdid=1) }}">{{ dirs[i].values() | first }}</a>
          {% endfor %}
        {% else %}
          <span class="topbtn disabled">Нет доступных категорий</span>
        {% endif %}
      </div>
    </div>

    <div class="files-page__body">
      <!-- Подкатегории (поддиректории выбранной категории) -->
      <div class="subbar subcat">
        <div class="subbar__group">
          {% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) and (dirs[did].keys() | length) > 1 %}
            {% for i in range(1, dirs[did].keys() | length) %}
              <a class="topbtn {{ 'active' if i == sdid else '' }}" href="{{ url_for('files', did=did, sdid=i) }}">{{ (dirs[did].values() | list)[i] }}</a>
            {% endfor %}
          {% else %}
            <span class="topbtn disabled">Нет подкатегорий</span>
          {% endif %}
        </div>
      </div>

      <table class="files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" role="table" aria-label="Таблица файлов" data-can-add="{{ 1 if current_user.has('files.upload') else 0 }}" data-can-mark-view="{{ 1 if current_user.has('files.mark_viewed') else 0 }}" data-can-notes="{{ 1 if current_user.has('files.notes') else 0 }}" data-current-user="{{ current_user.name }}">
        <thead class="table__head">
          <tr class="table__head_row" role="row">
            <th class="table__head_item" scope="col">Название</th>
            <th class="table__head_item" scope="col">Описание</th>
            <th class="table__head_item" scope="col">Создатель</th>
            <th class="table__head_item" scope="col">Дата создания</th>
            <th class="table__head_item" scope="col">Длина</th>
            <th class="table__head_item" scope="col">Размер</th>
            <th class="table__head_item" scope="col">Примечания</th>
          </tr>
        </thead>
        <tbody class="table__body" role="rowgroup">
          <tr id="search" class="table__body_actions">
            <td class="table__body_action" colspan="7">
              {% include 'components/searchbar.html' %}
            </td>
            <!--<td>
            {% if current_user.has('files.upload') %}
              <td class="table__body_action files-page__table--actions">
                <button type="button" class="topbtn d-inline-flex align-items-center table__body_action-add" onclick="popupToggle('popup-add');"><i class="bi bi-plus-lg"></i></button>
                <button type="button" class="topbtn d-inline-flex align-items-center table__body_action-record" onclick="popupToggle('popup-rec');"><i class="bi bi-camera-video"></i></button>
              </td>
            {% endif %}-->
          </tr>
          {% if files %}
            {% for file in files %}
              {% if file.ready %}
                <tr class="table__body_row" role="row" id="{{ file.id }}" data-id="{{ file.id }}" data-url="{{ url_for('files_show', did=did, sdid=sdid, name=file.real_name) }}" data-download="{{ url_for('files_show', did=did, sdid=sdid, name=file.real_name) }}"
                  data-can-edit="{{ 1 if (current_user.name + ' (' in file.owner or current_user.has('files.edit_any')) else 0 }}"
                  data-can-delete="{{ 1 if (current_user.has('files.delete_any') or current_user.name + ' (' in file.owner) else 0 }}"
                  data-can-note="{{ 1 if current_user.has('files.notes') else 0 }}"
                  data-view-url="{{ url_for('files_view', id=file.id, did=did, sdid=sdid) if current_user.has('files.mark_viewed') else '' }}"
                  data-viewed="{{ 1 if file.viewed else 0 }}"
                  data-already-viewed="{{ 1 if (file.viewed and (current_user.name in file.viewed)) else 0 }}"
                  data-others-viewed="{% if file.viewed %}{% set fv = file.viewed %}{% if (current_user.name not in fv) %}1{% elif (fv|replace(current_user.name, '')|replace(',', '')|replace(' ', '')) %}1{% else %}0{% endif %}{% else %}0{% endif %}"
                  data-root="{% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) %}{{ (dirs[did].values() | list)[0] }}{% else %}{% endif %}"
                  data-sub="{% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) and (dirs[did].keys() | length) > sdid %}{{ (dirs[did].values() | list)[sdid] }}{% else %}{% endif %}"
                  data-note="{{ file.note if file.note else '' }}"
                  data-exists="{{ 1 if file.exists else 0 }}"
                >
                  <td class="table__body_item" role="cell"><span class="files-page__link">{{ file.display_name }}</span></td>
                  <td class="table__body_item" role="cell"><strong>{% if file.real_name.lower().endswith('.m4a') %}Аудио{% else %}Видео{% endif %}</strong>{% if file.description %}<br>{{ file.description }}{% endif %}</td>
                  <td class="table__body_item" role="cell">{{ file.owner }}</td>
                  <td class="table__body_item" role="cell">{{ file.date }}</td>
                  <td class="table__body_item" role="cell">{{ file.length_human }}</td>
                  <td class="table__body_item" role="cell">{{ file.size_human }}</td>
                  <td class="table__body_item" role="cell">
                    <div class="file-viewers">
                      <strong>Просмотревшие:</strong>
                      <span>{{ file.viewed if file.viewed else '—' }}</span>
                    </div>
                    <div class="mt-1">
                      {% if current_user.has('files.mark_viewed') %}
                        {% set already_viewed = (file.viewed and (current_user.name in file.viewed)) %}
                        {% if not already_viewed %}
                          <span onclick="window.markViewedAjax({{ file.id }});">Отметить просмотренным</span>
                        {% endif %}
                      {% endif %}
                    </div>
                    <div class="mt-1">
                      {% if current_user.has('files.notes') %}
                        <span class="note-badge{{ ' note-badge--has' if file.note }}" onclick="popupValues(document.getElementById('note'), {{ file.id }}); popupToggle('popup-note', {{ file.id }});">{{ 'Примечание: ' + file.note if file.note else '<оставить примечание>' }}</span>
                      {% else %}
                        <span class="note-badge{{ ' note-badge--has' if file.note }}">{{ file.note and ('Примечание: ' + file.note) or '—' }}</span>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% else %}
                <tr class="table__body_row" role="row" id="{{ file.id }}"
                  data-id="{{ file.id }}"
                  data-url="{{ url_for('files_orig', did=did, sdid=sdid, name=file.real_name) }}"
                  data-download="{{ url_for('files_orig', did=did, sdid=sdid, name=file.real_name) }}"
                  data-can-edit="{{ 1 if (current_user.name + ' (' in file.owner or current_user.has('files.edit_any')) else 0 }}"
                  data-can-delete="{{ 1 if (current_user.has('files.delete_any') or current_user.name + ' (' in file.owner) else 0 }}"
                  data-can-note="{{ 1 if current_user.has('files.notes') else 0 }}"
                  data-root="{% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) %}{{ (dirs[did].values() | list)[0] }}{% else %}{% endif %}"
                  data-sub="{% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) and (dirs[did].keys() | length) > sdid %}{{ (dirs[did].values() | list)[sdid] }}{% else %}{% endif %}"
                  data-is-ready="0"
                  data-exists="{{ 1 if file.exists else 0 }}"
                >
                  <td class="table__body_item" role="cell">{{ file.display_name }}</td>
                  <td class="table__body_item" role="cell"><strong>{% if file.real_name.lower().endswith('.m4a') %}Аудио{% else %}Видео{% endif %}</strong>{% if file.description %}<br>{{ file.description }}{% endif %}</td>
                  <td class="table__body_item" role="cell">{{ file.owner }}</td>
                  <td class="table__body_item" role="cell">{{ file.date }}</td>
                  <td class="table__body_item" role="cell">{{ file.length_human }}</td>
                  <td class="table__body_item" role="cell">{{ file.size_human }}</td>
                  <td class="table__body_item" role="cell">
                    Обрабатывается...
                    <div class="d-inline-flex gap-2 ms-2 align-items-center">
                      <a class="files-page__setting btn btn-link p-0 d-inline-flex align-items-center" href={{ url_for("files_orig", did=did, sdid=sdid, name=file.real_name) }} download><i class="bi bi-download"></i> Скачать исходный файл</a>
                      {% if current_user.has('files.delete_any') or current_user.name + ' (' in file.owner %}
                        <button class="files-page__setting btn btn-link p-0 d-inline-flex align-items-center" onclick="popupToggle('popup-delete', {{ file.id }});"><i class="bi bi-trash3"></i> Удалить</button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
      <div id="files-pagination" class="files-pagination d-flex justify-content-center py-2"></div>

      <!-- Context menu for table rows -->
      <div id="context-menu" class="context-menu d-none">
        <ul class="context-menu__list">
          <li class="context-menu__item" data-action="open">Открыть</li>
          <li class="context-menu__item" data-action="download">Скачать</li>
          <li class="context-menu__item" data-action="edit">Изменить</li>
          <li class="context-menu__item" data-action="delete">Удалить</li>
          <li class="context-menu__item" data-action="move">Переместить</li>
          <li class="context-menu__item" data-action="refresh">Обновить информацию</li>
          <li class="context-menu__item" data-action="mark-viewed">Пометить просмотренным</li>
          <li class="context-menu__item" data-action="note">Оставить примечание</li>
          <li class="context-menu__separator"></li>
          <li class="context-menu__item" data-action="add">Загрузить</li>
          <li class="context-menu__item" data-action="record">Записать</li>
        </ul>
      </div>


    </div>
  </section>

  <div id="popup-add" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-add-title">
      <h1 class="popup__title mb-4" id="popup-add-title">Добавление файлов</h1>
      <form class="popup__form" id="add" action="{{ url_for('files_add', did=did, sdid=sdid) }}" method="post" enctype="multipart/form-data" autocomplete="off" onsubmit="return false;">

        <div class="popup__form-control form-control">
          <label class="form-control__label" for="add-name">Название:</label>
          <input class="form-control__control input" type="text" name="name" id="add-name" placeholder="Имя файла..." autocomplete="off">
        </div>
        <div class="popup__form-control form-control">

          <label class="form-control__label" for="add-description">Описание файла:</label>
          <textarea class="form-control__control input" id="add-description" name="description" placeholder="Введите описание Файла..." autocomplete="off"></textarea>
        </div>
        <div class="popup__form-control form-control">

          <label class="form-control__label" for="file">Выбрать файлы (до {{ (config['files'].get('max_upload_files') if config and config.get('files') else 5) }} шт.):</label>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input class="form-control__control" type="file" name="file" id="file" multiple autocomplete="off"
              accept="video/*,audio/*,.mp4,.webm,.avi,.mov,.mkv,.wmv,.flv,.m4v,.mp3,.wav,.flac,.aac,.m4a,.ogg,.oga,.wma,.mka,.opus">
          </div>
          <small class="form-text text-muted">Можно выбрать несколько файлов. Максимум: {{ (config['files'].get('max_upload_files') if config and config.get('files') else 5) }}. При множественной загрузке используются реальные имена файлов.</small>
          <input type="hidden" id="max-upload-files" value="{{ (config['files'].get('max_upload_files') if config and config.get('files') else 5) }}" autocomplete="off">
          <input type="hidden" id="max-file-size-mb" value="{{ max_file_size_mb }}" autocomplete="off">
          <small class="form-text text-muted">Максимальный размер: {{ max_file_size_mb }}MB. Поддерживаемые форматы видео: MP4, WebM, AVI, MOV, MKV, WMV, FLV, M4V; аудио: MP3, WAV, FLAC, AAC, M4A, OGG/OPUS, WMA</small>
        </div>
        <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
          <button type="button" class="btn btn-secondary" id="add-cancel-btn" onclick="popupToggle('popup-add');" >Отмена</button>
          <button type="button" class="btn btn-primary" id="add-submit-btn" onclick="validateForm(this);">Добавить</button>
        </div>
        
        <!-- Progress bar for file upload -->
        <div id="upload-progress" class="upload-progress d-none">
          <div class="progress mb-2">
            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="upload-status text-center">
            <small class="text-muted">Загрузка файла...</small>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="popup-edit" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-edit-title">
      <h1 class="popup__title mb-4" id="popup-edit-title">Редактирование файла</h1>
      <div class="popup__body">

        <form class="popup__form" id="edit" action="{{ url_for('files_edit', did=did, sdid=sdid, id=0) }}" method="post" autocomplete="off" onsubmit="return false;">
          <div class="popup__form-control form-control">

            <label class="form-control__label" for="edit-name">Название:</label>
            <input class="form-control__control input" type="text" name="name" id="edit-name" placeholder="Имя файла..." autocomplete="off">
          </div>
          <div class="popup__form-control form-control">

            <label class="form-control__label" for="edit-description">Описание файла:</label>
            <textarea class="form-control__control input" id="edit-description" name="description" placeholder="Введите описание Файла..." autocomplete="off"></textarea>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-edit');" >Отмена</button>
            <button type="button" class="btn btn-primary" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-delete-title">
      <h1 class="popup__title mb-4" id="popup-delete-title">Удалить файл</h1>
      <div class="popup__body">

        <p>Вы действительно хотите удалить файл <b>vname</b>?</p>
        <form class="popup__form" id="delete" action="{{ url_for('files_delete', did=did, sdid=sdid, id=0) }}" method="post" autocomplete="off" onsubmit="return false;">
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-delete');" >Отмена</button>
            <button type="button" class="btn btn-danger" onclick="validateForm(this);">Удалить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-note" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-note-title">
      <h1 class="popup__title mb-4" id="popup-note-title">Примечание</h1>
      <div class="popup__body">

        <form class="popup__form" id="note" action="{{ url_for('files_note', did=did, sdid=sdid, id=0) }}" method="post" autocomplete="off" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="note-text">Примечание к записи:</label>
            <textarea class="form-control__control input" id="note-text" name="note" placeholder="Введите примечание..." autocomplete="off"></textarea>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-note');" >Отмена</button>
            <button type="button" class="btn btn-primary" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Recording modal -->
  <div id="popup-rec" class="overlay-container">
    <div class="popup popup--wide" role="dialog" aria-modal="true" aria-labelledby="popup-rec-title">
      <h1 class="popup__title mb-4" id="popup-rec-title">Запись файлов</h1>
      <div class="popup__body" style="padding: 0; overflow: hidden;">
        <iframe
          id="rec-iframe"
          src="about:blank"
          data-src="{{ url_for('record', did=did, sdid=sdid) }}?embed=1"
          allow="camera; microphone; display-capture"
          style="width: 100%; height: 70vh; border: 0; display:  block;"
        ></iframe>
        <script>
          (function syncIframeThemeImmediately(){
            try {
              var iframe = document.getElementById('rec-iframe');
              if (!iframe) return;
              function getTheme(){
                try {
                  var t = document.documentElement.getAttribute('data-theme')
                    || (document.body && document.body.getAttribute('data-theme'));
                  if (t) return t;
                  try { return localStorage.getItem('selectedTheme') || localStorage.getItem('theme') || 'light'; } catch(_) { return 'light'; }
                } catch(_) { return 'light'; }
              }
              var theme = getTheme();
              // Update data-src to include theme, do not trigger load yet
              var ds = iframe.getAttribute('data-src') || '';
              if (ds) {
                try {
                  var u2 = new URL(ds, window.location.origin);
                  u2.searchParams.set('embed', '1');
                  if (!u2.searchParams.has('theme')) u2.searchParams.set('theme', theme);
                  iframe.setAttribute('data-src', u2.toString());
                } catch(_) {
                  if (ds.indexOf('theme=') === -1) {
                    var join2 = ds.indexOf('?') !== -1 ? '&' : '?';
                    iframe.setAttribute('data-src', ds + join2 + 'theme=' + encodeURIComponent(theme));
                  }
                }
              }
            } catch(_) {}
          })();
        </script>
      </div>
      <div class="popup__actions">
        <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-rec');">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Video player modal -->
  <div id="popup-view" class="overlay-container">
    <div class="popup popup--wide" role="dialog" aria-modal="true" aria-labelledby="popup-view-title">
      <h1 class="popup__title mb-4" id="popup-view-title">Просмотр файла</h1>
      <div class="popup__body">
        <video id="player-video" style="width: 100%; height: auto; outline: none;" controls playsinline></video>
      </div>
      <div class="popup__actions">
        <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-view');">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Audio player modal -->
  <div id="popup-audio" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-audio-title">
      <h1 class="popup__title mb-4" id="popup-audio-title">Прослушивание аудио</h1>
      <div class="popup__body">
        <audio id="player-audio" style="width: 100%; outline: none;" controls preload="none"></audio>
      </div>
      <div class="popup__actions">
        <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-audio');">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Move file modal -->
  <div id="popup-move" class="overlay-container">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-move-title">
      <h1 class="popup__title mb-4" id="popup-move-title">Переместить файл</h1>
      <div class="popup__body">
        <form class="popup__form" id="move" action="{{ url_for('files_move', did=did, sdid=sdid, id=0) }}" method="post" autocomplete="off" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="move-target-root">Выберите категорию:</label>
            <select class="form-control__control input" name="target_root" id="move-target-root">
              {% if dirs and (dirs | length) > 0 %}
                {% for i in range(dirs | length) %}
                  <option value="{{ (dirs[i].values() | list)[0] }}">{{ (dirs[i].values() | list)[0] }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>Нет доступных категорий</option>
              {% endif %}
            </select>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="move-target-sub">Выберите подкатегорию:</label>
            <select class="form-control__control input" name="target_sub" id="move-target-sub">
              {% if dirs and (dirs | length) > 0 and did is not none and did < (dirs | length) and (dirs[did].keys() | length) > 1 %}
                {% for i in range(1, dirs[did].keys() | length) %}
                  <option value="{{ (dirs[did].values() | list)[i] }}">{{ (dirs[did].values() | list)[i] }}</option>
                {% endfor %}
              {% else %}
                <option value="" disabled>Нет подкатегорий</option>
              {% endif %}
            </select>
          </div>
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-move');" >Отмена</button>
            <button type="button" class="btn btn-primary" onclick="validateForm(this);">Переместить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}
<script>
// Фокус-ловушка для модальных окон файловой страницы (кастомные попапы)
(function setupFilesFocusTrap(){
  try {
    function applyTrap(popupEl){
      if (!popupEl) return;
      function onKeyDown(e){
        if (e.key !== 'Tab') return;
        const scope = popupEl;
        const focusables = scope.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
      // attach once
      if (!popupEl._trapBound) {
        popupEl.addEventListener('keydown', onKeyDown);
        popupEl._trapBound = true;
      }
      // focus first control
      const firstInput = popupEl.querySelector('input, select, textarea, button.btn-primary');
      if (firstInput) { try { firstInput.focus(); } catch(_) {} }
    }
    const overlays = document.querySelectorAll('.overlay-container .popup');
    overlays.forEach(p => applyTrap(p));
    // Наблюдаем за изменениями видимости, чтобы активировать фокус при открытии
    const mo = new MutationObserver((list)=>{
      list.forEach(m => {
        if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')){
          const popup = m.target.querySelector && m.target.querySelector('.popup');
          const cs = window.getComputedStyle(m.target);
          if (cs && cs.display !== 'none' && popup) applyTrap(popup);
        }
      });
    });
    document.querySelectorAll('.overlay-container').forEach(oc => {
      mo.observe(oc, { attributes: true, attributeFilter: ['style','class'] });
    });
  } catch(_) {}
})();
</script>
