{% extends 'base.j2.html' %}

{% block css %}
<link rel="stylesheet" href="{{url_for('static',filename='css/table.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/files.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/components/select.css')}}">
<link rel="stylesheet" href="{{url_for('static',filename='css/popup.css')}}" />
<link rel="stylesheet" href="{{url_for('static',filename='css/components/input.css')}}"/>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{{ url_for('static', filename='js/files.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
{% endblock %}

{% block main %}
  <section class="files-page container-fluid py-3">
    <!-- Категории (директории верхнего уровня) -->
    <div class="subbar cat">
      <div class="subbar__group">
        {% for i in range(dirs | length) %}
          <a class="topbtn {{ 'active' if i == did else '' }}" href="{{ url_for('files', did=i, sdid=1) }}">{{ dirs[i].values() | first }}</a>
        {% endfor %}
      </div>
    </div>

    <div class="files-page__body">
      <!-- Подкатегории (поддиректории выбранной категории) -->
      <div class="subbar subcat">
        <div class="subbar__group">
          {% for i in range(1, dirs[did].keys() | length) %}
            <a class="topbtn {{ 'active' if i == sdid else '' }}" href="{{ url_for('files', did=did, sdid=i) }}">{{ (dirs[did].values() | list)[i] }}</a>
          {% endfor %}
        </div>
      </div>

      <table class="files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" data-can-add="{{ 1 if current_user.is_allowed(id, 'b') else 0 }}" data-can-mark-view="{{ 1 if current_user.is_allowed(id, 'm') else 0 }}">
        <thead class="table__head">
          <tr class="table__head_row">
            <th class="table__head_item">Название</th>
            <th class="table__head_item">Описание</th>
            <th class="table__head_item">Создатель</th>
            <th class="table__head_item">Дата создания</th>
            <th class="table__head_item">Примечания</th>
          </tr>
        </thead>
        <tbody class="table__body">
          <tr class="table__body_actions">
            <td class="table__body_action" colspan="3">
              <div class="search searchbar">
                <input id="searchinp" type="text" placeholder="Поиск...">
                <button type="button" class="btn btn-link p-0 d-inline-flex align-items-center" onclick="searchClean()"><i class="bi bi-x-lg"></i></button>
              </div>
            </td>
            <td>
            {% if current_user.is_allowed(id, 'b') %}
            <td class="table__body_action files-page__table--actions">
              <button type="button" class="topbtn d-inline-flex align-items-center table__body_action-add" onclick="popupToggle('popup-add');"><i class="bi bi-plus-lg"></i></button>
              <button type="button" class="topbtn d-inline-flex align-items-center table__body_action-record" onclick="popupToggle('popup-rec');"><i class="bi bi-camera-video"></i></button>
            </td>
            {% endif %}
          </tr>
          {% if files %}
            {% for file in files %}
              {% if file.ready %}
                <tr class="table__body_row" id="{{ file.id }}" data-id="{{ file.id }}" data-url="{{ url_for('files_show', did=did, sdid=sdid, name=file.real_name) }}" data-download="{{ url_for('files_show', did=did, sdid=sdid, name=file.real_name) }}"
                  data-can-edit="{{ 1 if (current_user.name + ' (' in file.owner or current_user.is_allowed(id, 'c')) else 0 }}"
                  data-can-delete="{{ 1 if (current_user.is_allowed(id, 'd') or current_user.name + ' (' in file.owner) else 0 }}"
                  data-can-note="{{ 1 if current_user.is_allowed(id, 'm') else 0 }}"
                  data-view-url="{{ url_for('files_view', id=file.id, did=did, sdid=sdid) if current_user.is_allowed(id, 'm') else '' }}"
                  data-already-viewed="{{ 1 if (file.viewed and (current_user.name in file.viewed)) else 0 }}"
                  data-note="{{ file.note if file.note else '' }}"
                >
                  <td class="table__body_item"><span class="files-page__link">{{ file.display_name }}</span></td>
                  <td class="table__body_item">{{ file.description }}</td>
                  <td class="table__body_item">{{ file.owner }}</td>
                  <td class="table__body_item">{{ file.date }}</td>
                  {% if current_user.is_allowed(id, 'l') %}
                    <td class="table__body_item">
                      {# Visible to all: list of viewers in notes column #}
                      <div class="file-viewers">
                        <strong>Просмотревшие:</strong>
                        <span>{{ file.viewed if file.viewed else '—' }}</span>
                      </div>

                      {# Action: mark as viewed (permission 'm'), non-reversible; prevent repeat #}
                      {% if current_user.is_allowed(id, 'm') %}
                        {% set already_viewed = (file.viewed and (current_user.name in file.viewed)) %}
                        <div class="mt-1">
                          {% if not already_viewed %}
                            <span onclick="location.href='{{ url_for("files_view", id=file.id, did=did, sdid=sdid) }}'">Отметить просмотренным</span>
                          {% endif %}
                        </div>
                        <div class="mt-1">
                          <span onclick="popupToggle('popup-note', {{ file.id }});">{{ 'Примечание: ' + file.note if file.note else '<оставить примечание>' }}</span>
                        </div>
                      {% else %}
                        <div class="mt-1">
                          <span>{{ 'Примечание: ' + file.note if file.note else '<оставить примечание>' }}</span>
                        </div>
                      {% endif %}
                    </td>
                  {% endif %}
                </tr>
              {% else %}
                <tr>
                  <td class="table__body_item">{{ file.display_name }}</td>
                  <td class="table__body_item">{{ file.description }}</td>
                  <td class="table__body_item">{{ file.owner }}</td>
                  <td class="table__body_item">{{ file.date }}</td>
                  <td  class="table__body_item">Обрабатывается...</td>
                </tr>
              {% endif %}
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
      <div id="files-pagination" class="files-pagination d-flex justify-content-center py-2"></div>

      <!-- Context menu for table rows -->
      <div id="context-menu" class="context-menu d-none">
        <ul class="context-menu__list">
          <li class="context-menu__item" data-action="open">Открыть</li>
          <li class="context-menu__item" data-action="download">Скачать</li>
          <li class="context-menu__item" data-action="edit">Изменить</li>
          <li class="context-menu__item" data-action="delete">Удалить</li>
          <li class="context-menu__item" data-action="mark-viewed">Пометить просмотренным</li>
          <li class="context-menu__item" data-action="note">Оставить примечание</li>
          <li class="context-menu__separator"></li>
          <li class="context-menu__item" data-action="add">Загрузить</li>
          <li class="context-menu__item" data-action="record">Записать</li>
        </ul>
      </div>


    </div>
  </section>

  <div id="popup-add" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title">Добавление видео</h1>
      <form class="popup__form" id="add" action="{{ url_for(pages[id].name + '_add', did=did, sdid=sdid) }}" method="post" enctype="multipart/form-data">

        <div class="popup__form-control form-control">
          <label class="form-control__label">Название:</label>
          <input class="form-control__control input" type="text" name="name" id="add-name" placeholder="Имя файла..." autocomplete="one-time-code">
        </div>
        <div class="popup__form-control form-control">

          <label class="form-control__label">Описание файла:</label>
          <textarea class="form-control__control input" name="description" placeholder="Введите описание Файла..."></textarea>
        </div>
        <div class="popup__form-control form-control">

          <label class="form-control__label">Выбрать файл:</label>
          <input class="form-control__control" type="file" name="file" id="file" multiple=false accept="video/mp4,video/webm,video/avi,video/quicktime,video/x-msvideo,video/x-ms-wmv,video/x-flv,video/x-m4v" >
          <input type="hidden" id="max-file-size-mb" value="{{ max_file_size_mb }}">
          <small class="form-text text-muted">Максимальный размер: {{ max_file_size_mb }}MB. Поддерживаемые форматы: MP4, WebM, AVI, MOV, MKV, WMV, FLV, M4V</small>
        </div>
        <div class="popup__actions">
          <button type="submit" class="btn btn-primary" id="add-submit-btn" onclick="return validateForm(this.parentElement);">Добавить</button>
          <button type="button" class="btn btn-secondary" id="add-cancel-btn" onclick="popupToggle('popup-add');" >Отмена</button>
        </div>
        
        <!-- Progress bar for file upload -->
        <div id="upload-progress" class="upload-progress d-none">
          <div class="progress mb-2">
            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="upload-status text-center">
            <small class="text-muted">Загрузка файла...</small>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="popup-edit" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title">Редактирование видео</h1>
      <div class="popup__body">

        <form class="popup__form" id="edit" action="{{ url_for(pages[id].name + '_edit', did=did, sdid=sdid, id=0) }}" method="post">
          <div class="popup__form-control form-control">

            <label class="form-control__label">Название:</label>
            <input class="form-control__control input" type="text" name="name" id="edit-name" placeholder="Имя файла..." autocomplete="one-time-code">
          </div>
          <div class="popup__form-control form-control">

            <label class="form-control__label">Описание файла:</label>
            <textarea class="form-control__control input" name="description" placeholder="Введите описание Файла..."></textarea>
          </div>

          <div class="popup__actions">
            <button type="submit" class="btn btn-primary" onclick="return validateForm(this.parentElement);">Сохранить</button>
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-edit');" >Отмена</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title">Удалить видео</h1>
      <div class="popup__body">

        <p>Вы действительно хотите удалить видео <b>vname</b>?</p>
        <form class="popup__form" id="delete" action="{{ url_for(pages[id].name + '_delete', did=did, sdid=sdid, id=0) }}" method="post">
          <div class="popup__actions">
            <button type="submit" class="btn btn-danger" onclick="return validateForm(this.parentElement);">Удалить</button>
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-delete');" >Отмена</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-note" class="overlay-container">
    <div class="popup">
      <h1 class="popup__title">Примечание</h1>
      <div class="popup__body">

        <form class="popup__form" id="note" action="{{ url_for(pages[id].name + '_note', did=did, sdid=sdid, id=0) }}" method="post">
          <div class="popup__form-control form-control">
            <label class="form-control__label">Примечание к записи:</label>
            <textarea class="form-control__control input" name="note" placeholder="Введите примечание..."></textarea>
          </div>

          <div class="popup__actions">
            <button type="submit" class="btn btn-primary" onclick="return validateForm(this.parentElement);">Сохранить</button>
            <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-note');" >Отмена</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Recording modal -->
  <div id="popup-rec" class="overlay-container">
    <div class="popup popup--wide">
      <h1 class="popup__title">Запись видео</h1>
      <div class="popup__body" style="padding: 0;">
        <iframe
          id="rec-iframe"
          src="{{ url_for('record', did=did, sdid=sdid) }}?embed=1"
          style="width: 100%; height: 70vh; border: 0; display: block;"
        ></iframe>
      </div>
      <div class="popup__actions">
        <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-rec');">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Video player modal -->
  <div id="popup-view" class="overlay-container">
    <div class="popup popup--wide">
      <h1 class="popup__title">Просмотр видео</h1>
      <div class="popup__body">
        <video id="player-video" style="width: 100%; height: auto; outline: none;" controls playsinline></video>
      </div>
      <div class="popup__actions">
        <button type="button" class="btn btn-secondary" onclick="popupToggle('popup-view');">Закрыть</button>
      </div>
    </div>
  </div>

{% endblock %}
